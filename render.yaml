# This is the single source of truth for deploying services to Render.
services:
  # The gallyfans-worker is a Web Service to have a public URL for the keep-alive ping.
  # This prevents the free instance from spinning down and losing the WhatsApp session.
  - type: web
    name: gallyfans-worker
    env: node
    region: oregon
    plan: free
    # The build and start commands are run from the root of the repository.
    buildCommand: "npm install && npx prisma generate --schema=prisma/schema.prisma && npx tsc -p gallyfans-worker/tsconfig.json"
    startCommand: "node gallyfans-worker/dist/index.js"
    healthCheckPath: /health
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: session-memory
      - fromGroup: 4Reels-secrets # Use the correct, existing env group

  # The Redis instance used for distributed locking.
  - type: redis
    name: session-memory
    region: oregon
    plan: free
    ipAllowList: [] # Open for development. Can be restricted later.

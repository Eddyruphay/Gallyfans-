# This is the single source of truth for deploying services to Render.
services:
  # The gallyfans-worker is a Web Service to have a public URL for the keep-alive ping.
  # This prevents the free instance from spinning down and losing the WhatsApp session.
  - type: web
    name: gallyfans-worker
    env: node
    region: oregon
    plan: free
    # The build and start commands are run from the root of the repository.
    buildCommand: "npm install && npm run build"
    startCommand: "npm start"
    healthCheckPath: /health
    envVars:
      - fromGroup: 4Reels-secrets # Assumes the new REDIS_* vars are in this group

  # The new whatsapp-sender microservice
  - type: web
    name: whatsapp-sender
    env: node
    region: oregon
    plan: free
    rootDir: ./whatsapp-sender
    buildCommand: "npm install && npm run build"
    startCommand: "npm run start"
    healthCheckPath: /
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: session-memory
      - fromGroup: 4Reels-secrets # For API_KEY and WA_SESSION_CREDS_JSON

  # The Redis instance used for distributed locking.
  - type: redis
    name: session-memory
    region: oregon
    plan: free
    ipAllowList: [] # Open for development. Can be restricted later.

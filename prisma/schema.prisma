// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"

}

// -------------------------------------------------
// --- CORE DATA MODELS
// -------------------------------------------------

model Creator {
  id               Int      @id @default(autoincrement())
  name             String   @unique
  slug             String   @unique
  status           String   @default("active")
  sourceSite       String?
  sourceExternalId String?
  bio              String?
  createdAt        DateTime @default(now()) @map("created_at")

  galleries Gallery[]

  @@map("creators")
}

model Gallery {
  id                 Int      @id @default(autoincrement())
  modelId            Int
  originalId         String?
  title              String
  channel            String?
  originalRating     Int?
  originalViews      Int?
  gallyfansVotesUp   Int      @default(0) @map("gallyfans_votes_up")
  gallyfansVotesDown Int      @default(0) @map("gallyfans_votes_down")
  createdAt          DateTime @default(now()) @map("created_at")

  creator      Creator             @relation(fields: [modelId], references: [id], onDelete: Cascade)
  images       Image[]
  tags         GalleryTag[]
  categories   GalleryCategory[]
  versionItems EditionVersionItem[] // Replaces editionEntries

  @@unique([modelId, originalId])
  @@map("galleries")
}

model Image {
  id            Int      @id @default(autoincrement())
  galleryId     Int
  imageUrl      String   @unique @map("image_url")
  position      Int      @default(0)
  imageHash     String?  @map("image_hash")
  cloudflareUrl String?  @map("cloudflare_url")
  createdAt     DateTime @default(now()) @map("created_at")

  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@map("images")
}

// -------------------------------------------------
// --- METADATA & JOIN TABLES
// -------------------------------------------------

model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique

  galleries GalleryTag[]

  @@map("tags")
}

model Category {
  id   Int    @id @default(autoincrement())
  name String @unique

  galleries GalleryCategory[]

  @@map("categories")
}

model GalleryTag {
  galleryId Int
  tagId     Int

  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([galleryId, tagId])
  @@map("gallery_tags")
}

model GalleryCategory {
  galleryId  Int
  categoryId Int

  gallery  Gallery  @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([galleryId, categoryId])
  @@map("gallery_categories")
}

// -------------------------------------------------
// --- CURATION & PUBLISHING SYSTEM (GALLYFANS V2)
// -------------------------------------------------

model Edition {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  status      String   @default("draft")
  createdAt   DateTime @default(now()) @map("created_at")

  versions EditionVersion[] // Replaces galleries

  @@map("editions")
}

model EditionVersion {
  id            Int      @id @default(autoincrement())
  editionId     Int
  versionNumber Int      @map("version_number")
  status        String   @default("draft") // 'draft', 'published', 'archived'
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  edition Edition              @relation(fields: [editionId], references: [id], onDelete: Cascade)
  items   EditionVersionItem[]

  @@unique([editionId, versionNumber])
  @@map("edition_versions")
}

model EditionVersionItem {
  id        Int @id @default(autoincrement())
  versionId Int @map("version_id")
  galleryId Int @map("gallery_id")
  position  Int

  version EditionVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  gallery Gallery        @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@unique([versionId, galleryId])
  @@map("edition_version_items")
}

model PublishedItem {
  id                  Int       @id @default(autoincrement())
  editionVersionId    Int       @map("edition_version_id")
  galleryId           Int       @map("gallery_id")
  creatorName         String    @map("creator_name")
  galleryTitle        String    @map("gallery_title")
  images              Json      @db.JsonB
  status              String    @default("pending") // 'pending', 'processing', 'published', 'failed'
  createdAt           DateTime  @default(now()) @map("created_at")
  processingStartedAt DateTime? @map("processing_started_at")
  publishedAt         DateTime? @map("published_at")
  errorLog            String?   @map("error_log")

  publicationJobs PublicationJob[]

  @@index([status])
  @@map("published_items")
}

model PublicationJob {
  id              Int      @id @default(autoincrement())
  publishedItemId Int      @map("published_item_id")
  targetChannel   String   @map("target_channel")
  status          String // 'SUCCESS', 'FAILURE'
  completedAt     DateTime @default(now()) @map("completed_at")
  details         String?  @db.Text

  publishedItem PublishedItem @relation(fields: [publishedItemId], references: [id], onDelete: Cascade)

  @@map("publication_jobs")
}


// -------------------------------------------------
// --- SYSTEM & SERVICE SESSIONS
// -------------------------------------------------

model ServiceSession {
  id          String   @id
  sessionJson String   @map("session_json") @db.Text
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("service_sessions")
}